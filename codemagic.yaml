definitions:
  brew_cache: &rn_brew_cache
    cache_paths:
      - $HOME/opt/homebrew/Cellar
  rn_cache: &rn_cache
    cache_paths:
      - $CM_BUILD_DIR/node_modules
  ios_cache: &ios_cache
    cache_paths:
      - $HOME/Library/Caches/CocoaPods
      - $CM_BUILD_DIR/ios/Pods
  notify: &notify
    email:
      recipients:
        - engineering@flywithavi.com
      notify:
        success: true
        failure: true
  scripts:
    - &install_doppler
      name: Import Doppler secrets
      script: |
        brew install gnupg
        brew install dopplerhq/cli/doppler
        doppler secrets download --no-read-env \
          --no-file \
          --format env-no-quotes \
          --config $APP_ENV \
          --token $DOPPLER_TOKEN >> $CM_ENV
    - &make_env_file
      name: Make .env file
      script: |
        node ./scripts/make.env.js
    - &install_bundler
      name: Install bundler
      script: |
        gem install bundler
        bundle install
    - &install_imagemagick
      name: Install imagemagick
      script: |
        brew install imagemagick
    - &install_pod_dep
      name: Pod install
      script: |
        cd ios && pod install
    - &install_rn_dep
      name: Yarn install
      script: |
        yarn --version
        yarn --immutable --immutable-cache --check-cache
    - &mod_google_service_plist
      name: Mod GoogleService-Info.plist
      script: |
        cat ios/GoogleService-Info.${APP_ENV}.plist > ios/GoogleService-Info.plist
    - &create_firebase_credentials
      name: Create Firebase Credentials
      script: |
        echo "$FIREBASE_SERVICE_ACCOUNT" > $GOOGLE_APPLICATION_CREDENTIALS
    - &build_app
      name: Build Application
      script: |
        bundle exec fastlane $LANE

workflows:
  ios-beta-release:
    name: iOS Beta Release
    triggering:
      cancel_previous_builds: true
      events:
        - tag
      tag_patterns:
        - pattern: "*.*.0"
          include: true
      branch_patterns:
        - pattern: "beta"
          include: true
          source: true
    max_build_duration: 120
    instance_type: mac_mini_m1
    cache:
      cache_paths:
      - $CM_BUILD_DIR/ios/Pods
      - $CM_BUILD_DIR/node_modules
    environment:
      xcode: 14.3
      cocoapods: default
      groups:
        - Production_iOS
        - Production
        - Global
      vars:
        APP_ENV: production
        LANE: ios beta
        SENTRY_DSYM_PATH: $CM_BUILD_DIR/ios/build/Avi.app.dSYM.zip
        BUILD_NUMBER: $BUILD_NUMBER
        REPO: $CM_REPO_SLUG
        COMMIT_SHA: $CM_COMMIT
    scripts:
      - *install_bundler
      - *install_rn_dep
      - *install_pod_dep
      - *mod_google_service_plist
      - *create_firebase_credentials
      - *build_app
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
    publishing:
      <<: *notify
  ios-staging:
    name: iOS Staging
    triggering:
      cancel_previous_builds: true
      events:
        - push
      branch_patterns:
        - pattern: "staging"
          include: true
          source: true
    max_build_duration: 120
    instance_type: mac_mini_m1
    cache:
      cache_paths:
      - $CM_BUILD_DIR/ios/Pods
      - $CM_BUILD_DIR/node_modules
      - $CM_BUILD_DIR/.bundle/packages
      - $CM_BUILD_DIR/ios/build/DerivedData
      - $HOME/Library/Caches/Yarn
    environment:
      xcode: 15.1
      cocoapods: default
      groups:
        - Staging_iOS
        - Staging
        - Global
      vars:
        APP_ENV: staging
        LANE: ios staging
        SENTRY_DSYM_PATH: $CM_BUILD_DIR/ios/build/Avi.app.dSYM.zip
        BUILD_NUMBER: $BUILD_NUMBER
        REPO: $CM_REPO_SLUG
        COMMIT_SHA: $CM_COMMIT
        GOOGLE_APPLICATION_CREDENTIALS: $CM_BUILD_DIR/firebase_credentials.json
    scripts:
      - *install_bundler
      - *install_imagemagick
      - *install_rn_dep
      - *install_pod_dep
      - *install_doppler
      - *make_env_file
      - *mod_google_service_plist
      - *create_firebase_credentials
      - *build_app
    artifacts:
      - build/ios/ipa/*.ipa
      - $CM_BUILD_DIR/ios/*.ipa
      - $CM_BUILD_DIR/ios/*.dSYM.zip
